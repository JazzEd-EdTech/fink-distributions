Package: debhelper
Version: 12.7.1
Revision: 1
###
BuildDepends: <<
	fink (>= 0.32),
	dpkg-dev (>= 1.18.0),
	po4a
<<
#	dwz, elf only thing
Depends: <<
	autotools-dev,
	dh-autoreconf (>= 17),
	dh-strip-nondeterminism (>= 0.028),
	dpkg (>= 1.18.0),
	dpkg-dev (>= 1.18.2),
	file (>= 3.23),
	libdpkg-pm (>= 1.17.14),
	man-db,
	libdebhelper-pm (= %v-%r),
	po-debconf
<<
Suggests: <<
	dh-make
<<
###
Source: mirror:debian:/pool/main/d/%n/%n_%v.tar.xz
Source-Checksum: SHA256(a84d07307229cbbf7dcaa472383d0c40bdb4b8828365007ef69b05fdca1d5a6f)
SourceDirectory: %n
###
PatchScript: <<
perl -pi -e "s,..shell ..PERL. -MConfig -e \'print ..Config.vendorlib.\'.,%p/lib/perl5,g" Makefile
perl -pi -e 's,PREFIX=/usr,PREFIX=%p,g' Makefile

# Get bulk of /usr /etc and /var
perl -pi -e 's,--prefix=/usr,--prefix=%p,g' t/buildsystems/autoconf/configure
perl -pi -e 's,/etc,%p/etc,g' lib/Debian/Debhelper/Buildsystem/autoconf.pm t/buildsystems/autoconf/configure autoscripts/* dh_* debhelper.pod man/po4a/po/*
perl -pi -e 's,/var,%p/var,g' lib/Debian/Debhelper/Buildsystem/autoconf.pm t/buildsystems/autoconf/configure autoscripts/* dh_* debhelper.pod man/po4a/po/*
perl -pi -e 's,/usr,%p,g' lib/Debian/Debhelper/Buildsystem/autoconf.pm lib/Debian/Debhelper/Buildsystem/python_distutils.pm lib/Debian/Debhelper/Buildsystem/cmake.pm lib/Debian/Debhelper/Buildsystem/meson.pm lib/Debian/Debhelper/Buildsystem/qmake.pm lib/Debian/Debhelper/Buildsystem/perl_makemaker.pm lib/Debian/Debhelper/Dh_Lib.pm autoscripts/* dh dh_* debhelper.pod man/po4a/po/* t/*.t t/*/*.t
BASE=$(echo %p | sed -e 's,/,,'); \
perl -pi -e "s,usr,${BASE},g" lib/Debian/Debhelper/Buildsystem/autoconf.pm lib/Debian/Debhelper/Buildsystem/python_distutils.pm lib/Debian/Debhelper/Buildsystem/cmake.pm lib/Debian/Debhelper/Buildsystem/meson.pm lib/Debian/Debhelper/Buildsystem/qmake.pm lib/Debian/Debhelper/Buildsystem/perl_makemaker.pm lib/Debian/Debhelper/Dh_Lib.pm autoscripts/* dh dh_* debhelper.pod man/po4a/po/* t/*.t t/*/*.t t/dh_missing/template/Makefile t/dh_missing/template/debian/foo.install 

# Put back perl and make calls to system variants
perl -pi -e 's,%p/bin/perl,/usr/bin/perl,g' lib/Debian/Debhelper/Buildsystem/autoconf.pm lib/Debian/Debhelper/Buildsystem/python_distutils.pm lib/Debian/Debhelper/Buildsystem/cmake.pm lib/Debian/Debhelper/Buildsystem/meson.pm lib/Debian/Debhelper/Buildsystem/qmake.pm lib/Debian/Debhelper/Buildsystem/perl_makemaker.pm lib/Debian/Debhelper/Dh_Lib.pm autoscripts/* dh dh_* debhelper.pod man/po4a/po/* t/*.t t/*/*.t
perl -pi -e 's,%p/bin/make,/usr/bin/make,g' lib/Debian/Debhelper/Buildsystem/autoconf.pm lib/Debian/Debhelper/Buildsystem/python_distutils.pm lib/Debian/Debhelper/Buildsystem/cmake.pm lib/Debian/Debhelper/Buildsystem/meson.pm lib/Debian/Debhelper/Buildsystem/qmake.pm lib/Debian/Debhelper/Buildsystem/perl_makemaker.pm lib/Debian/Debhelper/Dh_Lib.pm autoscripts/* dh dh_* debhelper.pod man/po4a/po/* t/*.t t/*/*.t

#	perl -pi -e "s;[^vendor|foo\/]lib([\/]?)(?![a-zA-Z_, \}]);${BASE}/lib\1;g" $i;
BASE=$(echo %p | sed -e 's,/,,'); \
for i in dh_*; do \
	perl -pi -e "s,[^\/]sbin,${BASE}/sbin,g" $i; \
	perl -pi -e "s,[^\/a-zA-Z]etc,${BASE}/etc,g" $i; \
	perl -pi -e "s,[^\/a-zA-Z%%\{\\$]var,${BASE}/var,g" $i; \
	perl -pi -e "s,usr/lib,lib,g" $i; \
	perl -pi -e "s,usr,${BASE},g" $i; \
	perl -pi -e "s,%p/bin/perl,/usr/bin/perl,g" $i; \
done; \
perl -pi -e "s,dh_${BASE}local,dh_usrlocal,g" dh; \
perl -pi -e "s,m/\\\/${BASE}/lib,m/\\\/lib,g" dh_strip

perl -pi -e 's,--strip-debug,-S,g' dh_strip
perl -pi -e 's,\\%p/lib/\\%p/etc,\\%p\\/lib/\\%p\\/etc,g' dh_installudev

perl -pi -e 's,-printf (.)\%p\/etc\/.P...,\| sed -e \1s;\$tmp;;g\1,g' dh_installdeb

perl -pi -e 's,--no-dereference 0:0," . getpwuid\(\$<\) . ":,g' dh_fixperms
perl -pi -e 's,\"0:0\",getpwuid\(\$<\) \. \":\",g' dh_* lib/Debian/Debhelper/Dh_Lib.pm
perl -pi -e 's;"-o",0;"-o",\$\<;g' dh_*
perl -pi -e 's;"-g",0;"-g",\(split " ", \$\( \)\[0\];g' dh_*
perl -pi -e 's;"-o", 0;"-o", \$\<;g' dh_*
perl -pi -e 's;"-g", 0;"-g", \(split " ", \$\( \)\[0\];g' dh_*

# Fixes so we don't need to be root, root or fink-bld is acceptable
perl -pi -e 's,\$\< != 0,\$\< != 0 and getpwuid\(\$<\) ne "fink-bld",g' dh_testroot
perl -pi -e 's,sub should_use_root {,sub should_use_root {\n\t\treturn 0;,g' lib/Debian/Debhelper/Dh_Lib.pm

# fixes for gnu tools cp, chmod, install
perl -pi -e 's,cp,gcp,g' dh_* t/*.t t/*/*.t
perl -pi -e 's/"install","-D"/"ginstall","-D"/g' dh_bugfiles
perl -pi -e 's,chmod,gchmod,g' dh_*
perl -pi -e 's;"rmdir","-p","--ignore-fail-on-non-empty";"grmdir","-p","--ignore-fail-on-non-empty";g' dh_gconf
perl -pi -e "s;'rmdir', '-p', '--ignore-fail-on-non-empty';'grmdir', '-p', '--ignore-fail-on-non-empty';g" dh_dwz dh_strip
perl -pi -e 's;"rmdir", "--ignore-fail-on-non-empty";"grmdir", "--ignore-fail-on-non-empty";g' dh_perl lib/Debian/Debhelper/Buildsystem.pm

# man-db doesn't not have --version
perl -pi -e 's,man --version,which man,g' dh_installman

# Remove from sequence since fink needs to do those.
for rmdh in dh_auto_test dh_builddeb dh_gencontrol dh_installifupdown dh_installinit dh_installinitramfs dh_installpam dh_installppp dh_installsystemd dh_installsystemduser dh_installudev dh_makeshlibs dh_md5sums dh_shlibdeps dh_systemd_enable dh_systemd_start dh_testroot dh_usrlocal; do \
	perl -pi -e "s,\t${rmdh}\n,,g" dh; \
done
perl -pi -e "s,[\(]!compat[\(]1,#(!compat(1,g" dh

# make sure fink libs are loaded
for i in dh*; do sed -i '2iBEGIN \{ push\(\@INC, "\%p\/lib\/perl5"\) \};' $i; done

# Remove unneeded tests
rm -rf t/dh_usrlocal t/dh_installsystem*

# Fix tests
perl -pi -e 's,export PERL5LIB=\$.pwd./lib,export PERL5LIB=\$(pwd)/lib:%p/lib/perl5,g' run
perl -pi -e 's,/usr,%p,g' t/dh_installman/01-basics.t t/dh_installdocs/01-868204-ignore-broken-symlinks.t t/dh_installdocs/dh_installdocs.t
perl -pi -e 's,linux-any,darwin-any,g' t/Dh_Lib/control-parsing.t t/Dh_Lib/debian/control

# Fix install
perl -pi -e 's,install ,ginstall ,g' Makefile
<<
###
CompileScript: <<
./run make
<<
###
InfoTest: <<
	TestScript: <<
		./run make test || exit 2
	<<
<<
###
InstallScript: <<
./run make install DESTDIR=%d

install -d -m755 %i/share/man/man1
install -m644 *.1 %i/share/man/man1
install -d -m755 %i/share/man/man7
install -m644 *.7 %i/share/man/man7
<<
###
DocFiles: debian/copyright debian/changelog doc/* examples
###
Description: Helper programs for debian/rules
DescDetail: <<
A collection of programs that can be used in a debian/rules file to
automate common tasks related to building debian packages. Programs
are included to install various files into your package, compress
files, fix file permissions, integrate your package with the debian
menu system, debconf, doc-base, etc. Most debian packages use debhelper
as part of their build process.
<<
###
SplitOff: <<
	Package: lib%N-pm
	Replaces: debhelper (<< 12.6)
#	Breaks: debhelper (<< 12.6)
	Files: <<
		share/%N
		lib
	<<
	DocFiles: debian/copyright debian/changelog
	Description: debhelper perl modules
	DescDetail: <<
A collection of programs that can be used in a debian/rules file to
automate common tasks related to building Debian packages.
.
This package provides the perl modules used by the scripts in debhelper.
	<<
<<
###
License: GPL
Homepage: http://packages.debian.org/unstable/debhelper
Maintainer: Justin F. Hallett <thesin@users.sourceforge.net>
